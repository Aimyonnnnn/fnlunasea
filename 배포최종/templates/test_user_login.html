<!DOCTYPE html>
<html>
<head>
    <title>í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ë¡œê·¸ì¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header text-center">
                        <h3>ğŸ§ª í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ë¡œê·¸ì¸</h3>
                    </div>
                    <div class="card-body">
                        {% if error %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endif %}
                        {% if success %}
                            <div class="alert alert-success">{{ success }}</div>
                        {% endif %}
                        
                        <form method="POST" id="loginForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">ì•„ì´ë””</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
                                <button type="button" class="btn btn-info" onclick="checkExpiry()">ğŸ“… ë§Œë£Œì¼ í™•ì¸</button>
                                <a href="{{ url_for('user_password_change') }}" class="btn btn-warning">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
                                <a href="{{ url_for('user_message') }}" class="btn btn-success">ğŸ’¬ ê´€ë¦¬ìì—ê²Œ ë©”ì‹œì§€</a>
                                <a href="{{ url_for('user_login') }}" class="btn btn-secondary">â† ì¼ë°˜ ë¡œê·¸ì¸</a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- ì•ˆë‚´ ì‚¬í•­ -->
                <div class="mt-4">
                    <div class="alert alert-info">
                        <h6>ğŸ“‹ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥</h6>
                        <ul class="mb-0">
                            <li><strong>ë§Œë£Œì¼ í™•ì¸</strong>: ê³„ì • ë§Œë£Œê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ í™•ì¸</li>
                            <li><strong>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</strong>: ì…€í”„ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</li>
                            <li><strong>ë§Œë£Œ ì•Œë¦¼</strong>: D-3ì¼ë¶€í„° ìë™ ì•Œë¦¼</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë§Œë£Œ ì•Œë¦¼ ëª¨ë‹¬ -->
    <div class="modal fade" id="expiryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader">
                    <h5 class="modal-title">ê³„ì • ë§Œë£Œ ì•Œë¦¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë‚´ìš© -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">í™•ì¸</button>
                    <button type="button" class="btn btn-primary" onclick="location.href='{{ url_for('user_password_change') }}'">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë§Œë£Œì¼ ì²´í¬
        window.addEventListener('load', function() {
            const username = document.getElementById('username').value;
            if (username) {
                checkExpiry();
            }
        });

        // ë¡œê·¸ì¸ í¼ ì œì¶œ ì‹œ ë§Œë£Œì¼ ì²´í¬
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            checkExpiryBeforeLogin();
        });

        function checkExpiry() {
            const username = document.getElementById('username').value;
            if (!username) {
                alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch('/api/check_expiry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({username: username})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.show_alert) {
                        showExpiryModal(data);
                    } else {
                        alert(`âœ… ê³„ì • ìƒíƒœ: ì •ìƒ\në§Œë£Œì¼: ${data.expiry_date}\në‚¨ì€ ì¼ìˆ˜: ${data.days_left}ì¼`);
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë§Œë£Œì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function checkExpiryBeforeLogin() {
            const username = document.getElementById('username').value;
            
            fetch('/api/check_expiry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({username: username})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.show_alert && data.urgency === 'expired') {
                    showExpiryModal(data);
                } else {
                    // ë§Œë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œê·¸ì¸ ì§„í–‰
                    document.getElementById('loginForm').submit();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // ì˜¤ë¥˜ ì‹œì—ë„ ë¡œê·¸ì¸ ì§„í–‰
                document.getElementById('loginForm').submit();
            });
        }

        function showExpiryModal(data) {
            const modal = new bootstrap.Modal(document.getElementById('expiryModal'));
            const modalHeader = document.getElementById('modalHeader');
            const modalBody = document.getElementById('modalBody');

            // ê¸´ê¸‰ë„ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ë§
            let headerClass = 'modal-header';
            let alertClass = 'alert';
            
            switch(data.urgency) {
                case 'expired':
                    headerClass += ' bg-danger text-white';
                    alertClass += ' alert-danger';
                    break;
                case 'critical':
                    headerClass += ' bg-warning text-dark';
                    alertClass += ' alert-warning';
                    break;
                case 'high':
                    headerClass += ' bg-warning text-dark';
                    alertClass += ' alert-warning';
                    break;
                case 'medium':
                    headerClass += ' bg-info text-white';
                    alertClass += ' alert-info';
                    break;
            }

            modalHeader.className = headerClass;
            
            modalBody.innerHTML = `
                <div class="${alertClass}">
                    <h6>${data.message}</h6>
                    <hr>
                    <p><strong>ë§Œë£Œì¼:</strong> ${data.expiry_date}</p>
                    <p><strong>ë‚¨ì€ ì¼ìˆ˜:</strong> ${data.days_left}ì¼</p>
                    ${data.urgency !== 'expired' ? '<p>ê³„ì† ì‚¬ìš©í•˜ë ¤ë©´ ê´€ë¦¬ìì—ê²Œ ì—°ì¥ì„ ìš”ì²­í•˜ì„¸ìš”.</p>' : '<p>ê³„ì •ì´ ë§Œë£Œë˜ì–´ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'}
                </div>
            `;

            modal.show();
        }
    </script>
</body>
</html>
